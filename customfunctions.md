# Пользовательские функции в Google Таблицах

[Custom Functions in Google Sheets](https://developers.google.com/apps-script/guides/sheets/functions)

Google Таблицы предлагают сотни [встроенных функций](https://support.google.com/docs/topic/1361471?&hl=ru), таких как [СРЗНАЧ (AVERAGE)](https://support.google.com/docs/answer/3093615?hl=ru), [СУММ (SUM)](https://support.google.com/docs/answer/3093669?hl=ru) и [ВПР (VLOOKUP)](https://support.google.com/docs/answer/3093318?hl=ru). Когда их недостаточно для ваших нужд, вы можете использовать Google Apps Script, чтобы написать собственную функцию, например, конвертирование метров в мили или получение данных непосредственно из Интернета, и использовать ее как обычную встроенную функцию.

## Начало

Пользовательские функции создаются с использованием стандартного JavaScript.

Ниже приведена простая пользовательская функция `DOUBLE`, которая множает входящее значение на 2:

```js
function DOUBLE(input) {
  return input * 2;
}
```

Если вы не знаете, как использовать JavaScript, или у вас нет времени для изучения, посмотрите [дополнения к Таблицам](https://support.google.com/docs/answer/3641454?hl=ru), возможно, там уже есть нужная вам функция.

## Создание пользовательской функции

Чтобы написать пользовательскую функцию:
 1. Создайте или откройте Google Таблицу.
 - Выберите в главном меню Инструменты > Редактор скриптов... Если вы видите экран приветствия, то выберите "Пустой проект".
 - Удалите весь код из редактора. Для функции `DOUBLE`, описанной выше, просто скопируйте его и вставьте в редактор.
 - Выберите главное меню Файл > Сохранить. Задайте имя проекта и нажмите Готово. 

Это все! Теперь вы можете использовать свою пользовательскую функцию.

## Получение пользовательской функции из хранилища  дополнений

Хранилище дополнений предлагает несколько пользовательских функций в виде дополнений к Google Таблицам. Чтобы использовать или найти дополнение:
1. Создайте или откройте Google Таблицу.
- Выберите главное меню Дополнения > Установить дополнения.
- Откроется окно хранилища дополнений. В поле поиска введите "custom function" и нажмите ввод.
- Если вы нашли интересующее вас приложение, нажмите на кнопку "+БЕСПЛАТНО" для установки.
- Диалоговое окно может сообщить вам, что дополнение требует авторизации. Если это так, внимательно прочитайте сообщение и нажмите "Разрешить". После этого будет установлено дополнение.
- Дополнение установлено. Для использования его в других Таблицах откройте любую из них и выберите в главном меню Дополнения > [имя дополнения] > Используйте его в текущей Таблице.

## Использование пользовательской функции

После написания пользовательской функции или установки из хранилища дополнений ее легко использовать как обычную встроенную функцию:
1. Нажмите на ячейку, которую собираетесь использовать для функции.
- Введите знак равенства (`=`), за которым следует имя функции с каким-либо параметром. Например, `=DOUBLE(A1)`. Далее нажмите ввод.
- Ячейка какое-то мгновение будет отбражать "Loading...", а после этого выведет результат.
The cell will momentarily display Loading..., then return the result.

# Руководство по пользовательским функицям

Прежде чем создавать собственные функции, ознакомьтесь с инструкцией ниже.

## Выбор имени


В дополенние к стантартным соглашениям о выборе имени JavaScript функции, обратите внимание на следующее:
- Имя пользовательской функции должно отличаться от имен встроенных функций, таких как `SUM ()`.
- Имя функции не может заканчиваться символом подчеркивания `_`, который обозначает закрытую функцию в Apps Script.
- Имя должно быть объявлено в синтаксисе функции `function myFunction()`, а не в выражении `var myFunction = new Function()`.
- Использование прописных букв не имеет значения, в то время как в Таблицах функции традиционно используют написание все с заглавных.

## Аргументы

Как и встроенные функции, пользовательские могут принимать аргументы в виде входящих значений:
- Если вы обратитесь к функции с сылкой на одну ячейку в аргументе (как `=DOUBLE(A1)`), аргумент будет содержать значение этой ячейки.
- Если вы вызовете функцию с сылкой на диапазон ячеек в аргументе (как `=DOUBLE(A1:B10)`), то аргумент будет содержать двумерный массив значений этих ячеек. Например, на изображении ниже аргумент в `=DOUBLE(A1:B2)` интерпретируется как `double([[1,3],[2,4]])`. Обратите внимание, что пример `DOUBLE`, который приведен выше, должен быть изменен для работы с массивом.
![диапазон в аргументе](https://developers.google.com/apps-script/images/arguments-example.png)
- Аргументы должны быть [детерминированными](https://ru.wikipedia.org/wiki/%D0%94%D0%B5%D1%82%D0%B5%D1%80%D0%BC%D0%B8%D0%BD%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%BD%D1%8B%D0%B9_%D0%B0%D0%BB%D0%B3%D0%BE%D1%80%D0%B8%D1%82%D0%BC). То есть, встроенные функции, который каждый раз возвращают разный результат - такие как `NOW()` или `RAND()` - не разрешено использовать в качестве аргументов пользовательских функций. Если пользовательская функция пытается вернуть значение, основанное на одной из этих непостоянных встроенных функций, она будет отображать `Loading ...` до бесконечности.

## Возвращаемые значения

Каждая пользовательская функция должна возвращать значение для отображения:
- Если функция возвращает одно значение, то оно отображается в ячейке, в которой была вызвана функция.
- Если пользовательская функция возвращает двумерный массив значений, значения будут заполнять соседние клетки вправо и вниз до тех пор, как эти клетки остаются пустыми. Если же заполнение приведет к перезаписи существующих значений в соседних ячейках, пользовательская функция выдаст ошибку. Для примера, смотрите раздел по оптимизации пользовательских функций.
- Пользовательская функция не может повлиять на другие, чем на те, в которые она возвращает значение, ячейки. Другими словами, пользовательская функция не может редактировать произвольные диапазоны, а только те, из которых она вызывается и соседние. Чтобы редактировать произвольные ячееки, рекомендуется использовать пользовательское меню для запуска функции.
- Вызов пользовательской функции должн вернуть значение в течение 30 секунд. Если этого не произошло, то ячейка будет отображать сообщение об ошибке: "Внутренняя ошибка при выполнении пользовательской функции".